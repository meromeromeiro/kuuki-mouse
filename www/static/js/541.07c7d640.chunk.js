"use strict";(self.webpackChunkmy_app=self.webpackChunkmy_app||[]).push([[541],{2541:(t,e,i)=>{i.r(e),i.d(e,{default:()=>o});var s=i(5043);const a=class{constructor(t,e,i){this.canvas=void 0,this.context=void 0,this.width=void 0,this.height=void 0,this.baseWidth=void 0,this.baseHeight=void 0,this.canvas=t,this.context=t.getContext("2d"),this.baseWidth=e,this.baseHeight=i,this.width=t.width,this.height=t.height,this.context.scale(this.baseWidth/this.width,this.baseHeight/this.height)}getContext(){return this.context}setSize(t,e){this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e,this.context.scale(this.width/this.baseWidth,this.height/this.baseHeight)}transformCoordinates(t,e){return[t/(this.width/this.baseWidth),e/(this.height/this.baseHeight)]}drawRect(t,e,i,s){let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"lightblue";this.context.fillStyle=a,this.context.fillRect(t,e,i,s)}drawPoint(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"red";this.context.beginPath(),this.context.arc(t,e,5,0,2*Math.PI),this.context.fillStyle=i,this.context.fill(),this.context.closePath()}clear(){this.context.clearRect(0,0,this.width,this.height)}drawBackground(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"lightblue";this.clear(),this.drawRect(0,0,this.baseWidth,this.baseHeight,t)}setAlpha(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.context.globalAlpha=t}drawImage(t,e,i,s,a){s&&a?this.context.drawImage(t,e,i,s,a):this.context.drawImage(t,e,i)}drawImageSlice(t,e,i,s,a,h,n,r,o){this.context.drawImage(t,e,i,s,a,h,n,r,o)}drawText(t,e,i,s,a){this.context.fillStyle=null!==a&&void 0!==a?a:this.context.fillStyle;const h=this.context.font.match(/(\d+)px/);i+=parseInt(h[1],10);let n=0;for(;this.context.measureText(t.substring(0,n)).width<s&&(n++,!(n>t.length)););return n--,this.context.strokeText(t.substring(0,n),e,i,s),this.context.fillText(t.substring(0,n),e,i,s),0===t.substring(n).length?[e+this.context.measureText(t.substring(0,n)).width,i]:this.drawText(t.substring(n),e,i,s)}};const h=class{constructor(t){this.dialogueData=[],this.currentIndex=0,this.characterStates=[],this.dialogueData=t}getCurrentScript(){if(this.currentIndex>=this.dialogueData.length)return null;const t=this.dialogueData[this.currentIndex];return t.characters&&(this.characterStates=t.characters),{index:this.currentIndex,...t,characterStates:this.characterStates}}getNextScript(){const t=this.getCurrentScript();return this.currentIndex++,t}reset(){this.currentIndex=0,this.characterStates=[]}};const n=class extends a{constructor(t,e,i){super(t,e,i),this.images=void 0,this.scriptManager=void 0,this.renderState={background:"background",dialogueBox:"dialogueBox",characters:[],dialogueText:"",characterName:""},this.clickCount=0,this.isTyping=!1,this.currentText="",this.typingIndex=0,this.typingTimeout=void 0,this.lastRenderTime=0,this.typingInterval=50,this.startRenderLoop()}async initImages(t){const e=[];this.images={};for(const i in t){const s=new Promise(((e,s)=>{const a=new Image;a.src=t[i],a.onload=()=>{this.images[i]=a,e()},a.onerror=()=>s(new Error(`Failed to load image: ${i}`))}));e.push(s)}await Promise.all(e)}initScriptManager(t){this.scriptManager=new h(t)}async initInput(){this.canvas.addEventListener("click",(()=>{this.handleClick()}))}handleClick(){if(this.isTyping)this.finishTyping();else{if(0===this.clickCount)this.renderState.background="background";else{var t;const e=null===(t=this.scriptManager)||void 0===t?void 0:t.getNextScript();if(!e)return void this.resetState();this.startTyping(e.name,e.text),this.renderState.characters=e.characterStates||[]}this.clickCount++}}resetState(){var t;this.clickCount=0,this.renderState={background:"background",dialogueBox:"dialogueBox",characters:[],dialogueText:"",characterName:""},null===(t=this.scriptManager)||void 0===t||t.reset()}startTyping(t,e){this.isTyping=!0,this.renderState.characterName=t,this.currentText=e,this.typingIndex=0,this.typeNextCharacter()}finishTyping(){this.isTyping=!1,this.renderState.dialogueText=this.currentText,this.typingTimeout&&clearTimeout(this.typingTimeout)}typeNextCharacter(){this.typingIndex<this.currentText.length?(this.renderState.dialogueText=this.currentText.slice(0,this.typingIndex+1),this.typingIndex++,this.typingTimeout=window.setTimeout((()=>this.typeNextCharacter()),this.typingInterval)):this.isTyping=!1}render(){this.clear();const{background:t,dialogueBox:e,characters:i,dialogueText:s,characterName:a}=this.renderState;if(this.images&&this.images[t]&&this.drawImage(this.images[t],0,0,this.baseWidth,this.baseHeight),i.forEach((t=>{let{name:e,positionX:i,positionY:s}=t;this.images&&this.images[e]&&this.drawImage(this.images[e],i,s)})),this.images&&this.images[e]){const t=.25*this.baseHeight;this.drawImage(this.images[e],50,this.baseHeight-t-20,this.baseWidth-100,t)}if(a){const t=70,e=this.baseHeight-150;this.drawText(a,t,e,200,"white")}if(s){const t=70,e=this.baseHeight-100,i=this.baseWidth-140;this.drawText(s,t,e,i,"white")}}startRenderLoop(){const t=e=>{e-this.lastRenderTime>=1e3/60&&(this.render(),this.lastRenderTime=e),requestAnimationFrame(t)};requestAnimationFrame(t)}};var r=i(579);const o=()=>{const t=(0,s.useRef)(null),e=(0,s.useRef)(null),i=(0,s.useRef)(null);return(0,s.useEffect)((()=>{const s=e.current.offsetWidth,a=s/2,h=new n(t.current,1e3,500);h.setSize(s,a),h.drawBackground(),i.current=h,e.current.scrollIntoView({behavior:"smooth",block:"start"}),function(){const t=h,e=new Image;e.src="https://proxy.moonchan.xyz/bfs/archive/942752679f58223257855b4d8ed0299ee5c71904.jpg?proxy_host=i0.hdslb.com",e.onload=()=>{t.drawImage(e,200,100,800,600),t.drawImage(e,300,150,900,650),t.drawImageSlice(e,400,400,500,500,1600,150,200,300),t.drawImageSlice(e,800,400,500,500,1800,300,200,300)},e.onerror=t=>{console.error("Image load error:",t)},t.getContext().font="bold 24px Consolas";const[i,s]=t.drawText("123456789012345678901234567890123456789012345678901234567890123456789\r\nq0123456789012345678901234567890",50,50,500,"white");t.drawPoint(i,s),t.initImages({background:"https://upload.moonchan.xyz/api/01LLWEUU2LRX4IM56ORJFIBC3OE3YTMPN7/bg000.jpg",dialogueBox:"https://upload.moonchan.xyz/api/01LLWEUU7LESNYUQKX5VDJGMVDZY3SRS7I/main_gallery.png",c1:"https://upload.moonchan.xyz/api/01LLWEUU5FPZ7ZWIFZN5DIVS27ONL4RII3/\u968f\u4e00\u7acb\u7ed8.png",c2:"https://upload.moonchan.xyz/api/01LLWEUUYMMYE5CZOYHBBKH55CZEMQ7AFV/\u968f\u4e00\u9b54\u6cd5\u88c5.png"}),t.initScriptManager([{name:"a",text:"\u6d4b\u8bd5"},{name:"a",text:"123"},{name:"a",text:"321"},{name:"a",text:"\u6d4b\u8bd5\u6d4b\u8bd5\u6d4b\u8bd5\u6d4b\u8bd5"},{name:"a",text:"3111"},{name:"",text:"\u8fd9\u662f\u968f\u4e00\uff0c\u5f88\u53ef\u7231",characters:[{name:"c2",positionX:250,positionY:100}]},{name:"",text:"\u8fd9\u4e5f\u662f\u968f\u4e00\uff0c\u5f88\u53ef\u7231",characters:[{name:"c1",positionX:250,positionY:100}]},{name:"",text:"\u8fd9\u4e24\u4e2a\u90fd\u662f\u968f\u4e00\uff0c\u5f88\u53ef\u7231",characters:[{name:"c1",positionX:50,positionY:100},{name:"c2",positionX:550,positionY:100}]},{name:"watashi",text:"\u554a\u6211\u751a\u81f3\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u4ee3\u7801\u5199\u6210\u8fd9\u6837\u4e5f\u80fdwork.\u8981\u81ea\u5df1\u4fee\u4e00\u4e0b\u3002\u3002"},{name:"watashi",text:"\u6e05\u7406work\u5417\uff0c\u53ef\u80fd\u4e0dwork\uff0c\u7adf\u7136work\u4e86\u3002\u662f\u6211\u80a4\u6d45\u4e86\uff0cGPT\u7239",characters:[]}]),setTimeout((()=>{t.initInput()}),1e3)}()}),[]),(0,r.jsx)("div",{className:"flex flex-col h-screen bg-black w-full",ref:e,children:(0,r.jsx)("div",{className:"flex-grow flex justify-center items-center",children:(0,r.jsx)("canvas",{ref:t,className:"border border-black"})})})}}}]);
//# sourceMappingURL=541.07c7d640.chunk.js.map